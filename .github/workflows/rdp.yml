name: Ultra Performance RDP - Latest Windows
on:
  workflow_dispatch:
jobs:
  ultra-performance-rdp:
    runs-on: windows-2025  # Latest Windows Server 2025
    steps:
    - name: Checkout
      uses: actions/checkout@v4
    
    - name: Maximize CPU Performance
      run: |
        # Ultimate Performance Power Scheme
        powercfg -duplicatescheme e9a42b02-d5df-448d-aa00-03f14749eb61
        $scheme = (powercfg -list | Select-String "Ultimate").Line.Split()[3]
        powercfg -setactive $scheme
        
        # Extreme CPU Settings - 100% Performance Always
        $guid = (powercfg -getactivescheme).Split()[3]
        powercfg -setacvalueindex $guid SUB_PROCESSOR PROCTHROTTLEMAX 100
        powercfg -setacvalueindex $guid SUB_PROCESSOR PROCTHROTTLEMIN 100
        powercfg -setacvalueindex $guid SUB_PROCESSOR CPMINCORES 100
        powercfg -setacvalueindex $guid SUB_PROCESSOR CPMAXCORES 100
        powercfg -setacvalueindex $guid SUB_PROCESSOR PERFBOOSTMODE 1
        powercfg -setacvalueindex $guid SUB_PROCESSOR PERFBOOSTPOL 100
        powercfg -setactive $guid
        
        # Disable ALL power saving
        powercfg -change standby-timeout-ac 0
        powercfg -change hibernate-timeout-ac 0
        powercfg -change disk-timeout-ac 0
        powercfg -change monitor-timeout-ac 0
        powercfg -hibernate off
        
        # Maximum CPU priority for all processes
        Set-ItemProperty -Path "HKLM:\SYSTEM\CurrentControlSet\Control\PriorityControl" -Name "Win32PrioritySeparation" -Value 24
        
        Write-Host "âœ… CPU set to MAXIMUM performance - 100% always-on"
    
    - name: Windows Update & Optimization
      run: |
        # Force Windows Update
        Install-Module PSWindowsUpdate -Force
        Get-WindowsUpdate -AcceptAll -Install -AutoReboot
        
        # Disable non-essential services for CPU focus
        $services = @("DiagTrack","WSearch","Themes","TabletInputService","Fax","XblAuthManager","XblGameSave")
        foreach($svc in $services) {
            Stop-Service $svc -Force -ErrorAction SilentlyContinue
            Set-Service $svc -StartupType Disabled -ErrorAction SilentlyContinue
        }
        
        # Disable ALL visual effects
        Set-ItemProperty -Path "HKCU:\Software\Microsoft\Windows\CurrentVersion\Explorer\VisualEffects" -Name "VisualFXSetting" -Value 2
        Set-ItemProperty -Path "HKCU:\Control Panel\Desktop" -Name "UserPreferencesMask" -Value ([byte[]](0x90,0x12,0x03,0x80,0x10,0x00,0x00,0x00))
        
        Write-Host "âœ… Windows updated & optimized for maximum CPU performance"
    
    - name: Setup Ultra RDP
      run: |
        # Enable RDP with maximum performance
        Set-ItemProperty -Path 'HKLM:\System\CurrentControlSet\Control\Terminal Server' -Name "fDenyTSConnections" -Value 0
        Enable-NetFirewallRule -DisplayGroup "Remote Desktop"
        
        # Ultra performance RDP settings
        $rdp = 'HKLM:\System\CurrentControlSet\Control\Terminal Server\WinStations\RDP-Tcp'
        Set-ItemProperty -Path $rdp -Name "MaxInstanceCount" -Value 50
        Set-ItemProperty -Path $rdp -Name "fDisableWallpaper" -Value 1
        Set-ItemProperty -Path $rdp -Name "fDisableFullWindowDrag" -Value 1
        Set-ItemProperty -Path $rdp -Name "fDisableMenuAnims" -Value 1
        Set-ItemProperty -Path $rdp -Name "fDisableTheming" -Value 1
        Set-ItemProperty -Path $rdp -Name "fDisableComposition" -Value 1
        
        # Create admin user
        $pass = ConvertTo-SecureString "UltraAdmin2024!" -AsPlainText -Force
        New-LocalUser -Name "ultraadmin" -Password $pass -FullName "Ultra Admin" -PasswordNeverExpires -UserMayNotChangePassword
        Add-LocalGroupMember -Group "Administrators" -Member "ultraadmin"
        Add-LocalGroupMember -Group "Remote Desktop Users" -Member "ultraadmin"
        
        Write-Host "âœ… Ultra RDP configured - Username: ultraadmin | Password: UltraAdmin2024!"
    
    - name: Install & Start Playit
      env:
        PLAYIT_AUTH_KEY: ${{ secrets.PL }}
      run: |
        Invoke-WebRequest -Uri "https://github.com/playit-cloud/playit-agent/releases/download/v0.15.26/playit-windows-x86_64-signed.exe" -OutFile "playit.exe"
        
        # Start with REALTIME priority for maximum CPU access
        $proc = Start-Process -FilePath "playit.exe" -ArgumentList "--secret", "$env:PLAYIT_AUTH_KEY" -WindowStyle Hidden -PassThru
        $proc.PriorityClass = [System.Diagnostics.ProcessPriorityClass]::RealTime
        $proc.ProcessorAffinity = [System.IntPtr]::new([Math]::Pow(2, [Environment]::ProcessorCount) - 1)
        
        Write-Host "âœ… Playit started with REALTIME priority"
    
    - name: Final CPU Boost & Keep Alive
      run: |
        # Disable Windows Defender for maximum CPU
        Set-MpPreference -DisableRealtimeMonitoring $true
        
        # Set system to maximum performance mode
        powercfg -setactive 8c5e7fda-e8bf-4a96-9a85-a6e23a8c635c
        
        Write-Host "ðŸš€ ULTRA PERFORMANCE RDP READY!"
        Write-Host "ðŸ”¥ CPU: MAXIMUM performance, REALTIME priority"
        Write-Host "ðŸ‘¤ User: ultraadmin | ðŸ”‘ Pass: UltraAdmin2024!"
        Write-Host "âš¡ System: Latest Windows, fully updated"
        
        # Keep alive for 6 hours
        $end = (Get-Date).AddHours(6)
        while ((Get-Date) -lt $end) {
            # Maintain REALTIME priority on Playit
            $playit = Get-Process -Name "playit*" -ErrorAction SilentlyContinue
            if ($playit -and $playit.PriorityClass -ne "RealTime") {
                $playit.PriorityClass = [System.Diagnostics.ProcessPriorityClass]::RealTime
            }
            Start-Sleep 300
        }
        
        Write-Host "âœ… 6-hour ultra performance session completed"