name: Persistent Playit RDP Tunnel

on:
  workflow_dispatch:

jobs:
  setup-rdp-tunnel:
    runs-on: windows-latest

    steps:
    - name: üõ†Ô∏è Check out the repository
      uses: actions/checkout@v2

    # Enable Virtualization (Hyper-V, VM Support)
    - name: üñ•Ô∏è Enable Virtualization Support
      run: |
        # Check Windows Edition
        $WinEdition = (Get-ItemProperty -Path "HKLM:\SOFTWARE\Microsoft\Windows NT\CurrentVersion").EditionID
        Write-Host "Windows Edition Detected: $WinEdition"

        if ($WinEdition -match "Home") {
            Write-Host "‚ùå Hyper-V is not available on Windows Home. Skipping Hyper-V installation."
        } else {
            # Enable Hyper-V if supported
            Write-Host "üîÑ Enabling Hyper-V..."
            bcdedit /set hypervisorlaunchtype Auto

            Enable-WindowsOptionalFeature -Online -FeatureName Microsoft-Hyper-V-All -NoRestart -ErrorAction SilentlyContinue
            Enable-WindowsOptionalFeature -Online -FeatureName Microsoft-Hyper-V -NoRestart -ErrorAction SilentlyContinue
            Enable-WindowsOptionalFeature -Online -FeatureName Microsoft-Hyper-V-Platform -NoRestart -ErrorAction SilentlyContinue
        }

        # Enable Virtual Machine Platform (Alternative)
        Write-Host "üîÑ Enabling Virtual Machine Platform..."
        Enable-WindowsOptionalFeature -Online -FeatureName VirtualMachinePlatform -NoRestart -ErrorAction SilentlyContinue
        
        # Enable Windows Hypervisor Platform
        Write-Host "üîÑ Enabling Windows Hypervisor Platform..."
        Enable-WindowsOptionalFeature -Online -FeatureName HypervisorPlatform -NoRestart -ErrorAction SilentlyContinue

        # Use DISM as an alternative method
        Write-Host "üîÑ Using DISM to enable virtualization features..."
        DISM /Online /Enable-Feature /FeatureName:Microsoft-Hyper-V-All /All /NoRestart
        DISM /Online /Enable-Feature /FeatureName:HypervisorPlatform /All /NoRestart
        DISM /Online /Enable-Feature /FeatureName:VirtualMachinePlatform /All /NoRestart

        # Check if virtualization is enabled in BIOS
        $VirtualizationEnabled = (Get-ComputerInfo).HyperVRequirementDataExecutionPreventionAvailable
        if ($VirtualizationEnabled -eq $false) {
            Write-Host "‚ö†Ô∏è Virtualization is disabled in BIOS. Please enable it for Hyper-V to work."
            exit 1
        }

    # Reboot system to apply Hyper-V changes
    - name: üîÑ Reboot System
      run: |
        Write-Host "üîÑ Rebooting system to apply Hyper-V changes..."
        shutdown /r /t 10
