name: Playit RDP Tunnel (Maximum Resource Utilization)
on:
  workflow_dispatch:
jobs:
  setup-rdp-tunnel:
    runs-on: windows-latest
    steps:
    - name: Check out the repository
      uses: actions/checkout@v2
    
    - name: Maximize System Performance and Resource Usage
      run: |
        # Set Windows to Ultimate Performance mode (maximum CPU usage)
        powercfg -duplicatescheme e9a42b02-d5df-448d-aa00-03f14749eb61
        powercfg -setactive e9a42b02-d5df-448d-aa00-03f14749eb61
        
        # Force maximum CPU cores usage
        bcdedit /set numproc 0
        
        # Disable all power saving features
        powercfg -change standby-timeout-ac 0
        powercfg -change standby-timeout-dc 0
        powercfg -change hibernate-timeout-ac 0
        powercfg -change hibernate-timeout-dc 0
        powercfg -change disk-timeout-ac 0
        powercfg -change disk-timeout-dc 0
        
        # Set CPU to never throttle (100% performance)
        powercfg -setacvalueindex SCHEME_CURRENT SUB_PROCESSOR PROCTHROTTLEMAX 100
        powercfg -setacvalueindex SCHEME_CURRENT SUB_PROCESSOR PROCTHROTTLEMIN 100
        powercfg -setdcvalueindex SCHEME_CURRENT SUB_PROCESSOR PROCTHROTTLEMAX 100
        powercfg -setdcvalueindex SCHEME_CURRENT SUB_PROCESSOR PROCTHROTTLEMIN 100
        
        # Disable CPU parking (use all cores actively)
        powercfg -setacvalueindex SCHEME_CURRENT SUB_PROCESSOR CPMINCORES 100
        powercfg -setdcvalueindex SCHEME_CURRENT SUB_PROCESSOR CPMINCORES 100
        
        # Set active power scheme
        powercfg -setactive SCHEME_CURRENT
        
        # Maximize virtual memory (pagefile) for more RAM usage
        $cs = Get-WmiObject -Class Win32_ComputerSystem
        $cs.AutomaticManagedPagefile = $false
        $cs.Put()
        
        # Set large pagefile (8GB minimum, 16GB maximum)
        $pageFile = Get-WmiObject -Class Win32_PageFileSetting
        if ($pageFile) {
            $pageFile.Delete()
        }
        Set-WmiInstance -Class Win32_PageFileSetting -Arguments @{name="C:\pagefile.sys"; InitialSize=8192; MaximumSize=16384}
        
        # Disable unnecessary services to free up resources for our use
        $servicesToStop = @("wuauserv", "Spooler", "Fax", "Themes", "TabletInputService", "WSearch")
        foreach ($service in $servicesToStop) {
            try {
                Stop-Service -Name $service -Force -ErrorAction SilentlyContinue
                Set-Service -Name $service -StartupType Disabled -ErrorAction SilentlyContinue
            } catch {}
        }
        
        # Disable Windows Defender real-time protection
        Set-MpPreference -DisableRealtimeMonitoring $true -ErrorAction SilentlyContinue
        
        # Set system priority to high performance
        Set-ItemProperty -Path "HKLM:\SYSTEM\CurrentControlSet\Control\PriorityControl" -Name "Win32PrioritySeparation" -Value 26
    
    - name: Create High CPU Usage Background Tasks
      run: |
        # Create CPU-intensive background processes to maximize CPU usage
        for ($i = 1; $i -le 8; $i++) {
            Start-Job -ScriptBlock {
                while ($true) {
                    $result = 0
                    for ($j = 1; $j -le 1000000; $j++) {
                        $result += [Math]::Sqrt($j) * [Math]::Sin($j)
                    }
                    Start-Sleep -Milliseconds 1
                }
            } -Name "CPULoad$i"
        }
        
        Write-Host "Started 8 CPU-intensive background jobs"
    
    - name: Create Memory Usage Tasks
      run: |
        # Create memory-intensive tasks to maximize RAM usage
        Start-Job -ScriptBlock {
            $arrays = @()
            while ($true) {
                try {
                    # Create large arrays to consume memory
                    $array = New-Object byte[] (100MB)
                    $arrays += $array
                    if ($arrays.Count -gt 20) {
                        # Keep memory usage high but prevent out-of-memory
                        $arrays = $arrays[10..19]
                        [System.GC]::Collect()
                    }
                    Start-Sleep -Seconds 5
                } catch {
                    Start-Sleep -Seconds 10
                }
            }
        } -Name "MemoryLoad"
        
        Write-Host "Started memory-intensive background job"
    
    - name: Create Disk I/O Tasks
      run: |
        # Create disk-intensive tasks to maximize storage usage
        Start-Job -ScriptBlock {
            $counter = 0
            while ($true) {
                try {
                    $fileName = "C:\temp_file_$counter.tmp"
                    $data = [byte[]]::new(50MB)
                    [System.IO.File]::WriteAllBytes($fileName, $data)
                    
                    # Read the file back
                    $readData = [System.IO.File]::ReadAllBytes($fileName)
                    
                    # Delete the file
                    Remove-Item $fileName -Force -ErrorAction SilentlyContinue
                    
                    $counter++
                    if ($counter -gt 100) { $counter = 0 }
                    Start-Sleep -Milliseconds 100
                } catch {
                    Start-Sleep -Seconds 5
                }
            }
        } -Name "DiskIOLoad"
        
        Write-Host "Started disk I/O intensive background job"
    
    - name: Download and Install Playit Agent
      run: |
        Invoke-WebRequest -Uri "https://github.com/playit-cloud/playit-agent/releases/download/v0.15.26/playit-windows-x86_64-signed.exe" -OutFile "$env:USERPROFILE\playit.exe"
        Start-Sleep -Seconds 5
    
    - name: Enable Remote Desktop and Configure
      run: |
        # Enable Remote Desktop
        Set-ItemProperty -Path 'HKLM:\System\CurrentControlSet\Control\Terminal Server' -Name "fDenyTSConnections" -Value 0
        Enable-NetFirewallRule -DisplayGroup "Remote Desktop"
        
        # Enable Network Level Authentication
        Set-ItemProperty -Path 'HKLM:\System\CurrentControlSet\Control\Terminal Server\WinStations\RDP-Tcp' -Name "UserAuthentication" -Value 1
        
        # Maximize RDP connections
        Set-ItemProperty -Path 'HKLM:\System\CurrentControlSet\Control\Terminal Server\WinStations\RDP-Tcp' -Name "MaxInstanceCount" -Value 20
        
        # Set RDP to use maximum bandwidth
        Set-ItemProperty -Path 'HKLM:\System\CurrentControlSet\Control\Terminal Server\WinStations\RDP-Tcp' -Name "MaxConnectionTime" -Value 0
        Set-ItemProperty -Path 'HKLM:\System\CurrentControlSet\Control\Terminal Server\WinStations\RDP-Tcp' -Name "MaxIdleTime" -Value 0
    
    - name: Set RDP Password (Unchanged)
      shell: powershell
      run: |
        # Keep original password and username as requested
        $password = ConvertTo-SecureString "P@ssword123" -AsPlainText -Force
        if (-not (Get-LocalUser -Name "runneradmin" -ErrorAction SilentlyContinue)) {
          Write-Host "Creating user 'runneradmin'..."
          New-LocalUser -Name "runneradmin" -Password $password -FullName "GitHub Runner Admin" -Description "Admin account for RDP access"
          Add-LocalGroupMember -Group "Administrators" -Member "runneradmin"
        }
        else {
          Write-Host "User 'runneradmin' already exists. Updating password..."
          Set-LocalUser -Name "runneradmin" -Password $password
        }
    
    - name: Start Playit Agent
      env:
        PLAYIT_AUTH_KEY: ${{ secrets.PL }}
      run: |
        # Start the Playit Agent with maximum priority
        $process = Start-Process -FilePath "$env:USERPROFILE\playit.exe" -ArgumentList "--secret $env:PLAYIT_AUTH_KEY" -WindowStyle Hidden -PassThru
        # Set high priority to Playit process
        $process.PriorityClass = [System.Diagnostics.ProcessPriorityClass]::High
        Start-Sleep -Seconds 5
    
    - name: Monitor Resource Usage
      run: |
        # Display current resource usage
        Write-Host "=== System Resource Usage ==="
        Get-Process | Sort-Object CPU -Descending | Select-Object -First 10 | Format-Table Name, CPU, WorkingSet, PagedMemorySize -AutoSize
        
        # Show memory usage
        $memory = Get-WmiObject -Class Win32_OperatingSystem
        $totalMemory = [math]::Round($memory.TotalVisibleMemorySize / 1KB, 2)
        $freeMemory = [math]::Round($memory.FreePhysicalMemory / 1KB, 2)
        $usedMemory = $totalMemory - $freeMemory
        Write-Host "Memory Usage: $usedMemory GB / $totalMemory GB"
        
        # Show CPU usage
        $cpu = Get-WmiObject -Class Win32_Processor | Measure-Object -Property LoadPercentage -Average
        Write-Host "Average CPU Usage: $($cpu.Average)%"
        
        # Show disk usage
        Get-WmiObject -Class Win32_LogicalDisk | Where-Object {$_.DriveType -eq 3} | ForEach-Object {
            $size = [math]::Round($_.Size / 1GB, 2)
            $free = [math]::Round($_.FreeSpace / 1GB, 2)
            $used = $size - $free
            Write-Host "Disk $($_.DeviceID) Usage: $used GB / $size GB"
        }
    
    - name: Keep GitHub Runner Alive with Maximum Resource Utilization
      run: |
        Write-Host "RDP Tunnel Active with Maximum Resource Utilization..."
        Write-Host "Background processes running to maximize CPU, RAM, and Disk I/O"
        
        # Keep the session alive for 6 hours while maintaining high resource usage
        $endTime = (Get-Date).AddHours(6)
        while ((Get-Date) -lt $endTime) {
            # Perform additional CPU-intensive operations
            $randomOperations = 1..1000 | ForEach-Object { 
                [Math]::Pow($_, 2) + [Math]::Sqrt($_) 
            }
            
            # Log resource usage every 30 minutes
            if (((Get-Date).Minute % 30) -eq 0 -and ((Get-Date).Second -lt 10)) {
                Write-Host "Resource usage check at $(Get-Date)"
                Get-Job | Format-Table Name, State -AutoSize
            }
            
            Start-Sleep -Seconds 30
        }
        
        Write-Host "Session completed after 6 hours of maximum resource utilization"