name: Maximum Performance RDP Tunnel with Admin Access

on:
  workflow_dispatch:

jobs:
  max-performance-rdp:
    runs-on: windows-latest
    timeout-minutes: 360
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Apply full system and CPU performance optimizations
        run: |
          powershell -ExecutionPolicy Bypass -File optimize.ps1

      - name: Download and start Playit Agent with auto-recovery
        env:
          PLAYIT_AUTH_KEY: ${{ secrets.PL }}
        run: |
          $exe = "$env:USERPROFILE\playit.exe"
          Invoke-WebRequest -Uri "https://github.com/playit-cloud/playit-agent/releases/download/v0.15.26/playit-windows-x86_64-signed.exe" -OutFile $exe -UseBasicParsing
          Start-Process -FilePath $exe -ArgumentList "--secret", "$env:PLAYIT_AUTH_KEY" -WindowStyle Hidden -PassThru | ForEach-Object {
              $_.PriorityClass = [System.Diagnostics.ProcessPriorityClass]::High
              $_.ProcessorAffinity = [System.IntPtr]::new([Math]::Pow(2, [Environment]::ProcessorCount) - 1)
          }

      - name: Enable and configure RDP with performance tuning
        run: |
          powershell -Command "& {
            Set-ItemProperty -Path 'HKLM:\System\CurrentControlSet\Control\Terminal Server' -Name 'fDenyTSConnections' -Value 0
            Enable-NetFirewallRule -DisplayGroup 'Remote Desktop'
            Start-Service -Name 'TermService'
            Set-Service -Name 'TermService' -StartupType Automatic
          }"

      - name: Create RDP Admin User
        run: |
          powershell -Command "& {
            $p = ConvertTo-SecureString 'SuperAdmin2024!' -AsPlainText -Force
            Try { Remove-LocalUser -Name 'rdpadmin' -ErrorAction SilentlyContinue } Catch {}
            New-LocalUser -Name 'rdpadmin' -Password $p -PasswordNeverExpires
            Add-LocalGroupMember -Group 'Administrators' -Member 'rdpadmin'
            Add-LocalGroupMember -Group 'Remote Desktop Users' -Member 'rdpadmin'
          }"

      - name: Monitor Playit and maintain performance for 6 hours
        run: |
          powershell -Command "& {
            $end = (Get-Date).AddHours(6)
            while ((Get-Date) -lt $end) {
              Start-Sleep -Seconds 180
              $proc = Get-Process playit* -ErrorAction SilentlyContinue
              if ($proc) {
                if ($proc.PriorityClass -ne 'High') {
                  $proc.PriorityClass = 'High'
                }
              } else {
                Start-Process -FilePath \"$env:USERPROFILE\playit.exe\" -ArgumentList \"--secret\", \"$env:PLAYIT_AUTH_KEY\" -WindowStyle Hidden -PassThru | ForEach-Object {
                  $_.PriorityClass = [System.Diagnostics.ProcessPriorityClass]::High
                  $_.ProcessorAffinity = [System.IntPtr]::new([Math]::Pow(2, [Environment]::ProcessorCount) - 1)
                }
              }
            }
          }"

      - name: Done
        run: echo "âœ… Maximum Performance RDP session ended after 6 hours"
